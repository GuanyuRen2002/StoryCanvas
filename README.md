# StoryCanvas - 智能绘本生成器

一个基于AI技术的智能儿童绘本生成系统，能够自动创作包含故事文本、精美插图和语音朗读的完整绘本。系统集成了多个先进的AI服务，为用户提供一站式的绘本创作体验。

## 🎯 核心功能

### 1. 智能故事生成
- **双引擎支持**：优先使用Gemini 2.0 Flash，备用OpenAI GPT-4
- **自然语言输入**：支持用户用自然语言描述想要的故事内容
- **智能分析**：AI自动分析用户输入，提取故事主题、角色和场景
- **结构化创作**：生成包含角色详细描述、场景设定和10页连贯故事内容
- **儿童友好**：内容适合儿童，积极正面，富有教育意义

### 2. AI图像生成
- **多种画风支持**：
  - 默认水彩风格（儿童绘本专用）
  - 摄影写实风格
  - 概念艺术风格
  - 卡通动漫风格
  - 古典绘画风格
  - 像素艺术风格
  - 赛博朋克风格
  - 低面建模风格
  - 纸艺风格
  - 宫崎骏风格

- **角色一致性保证**：
  - 标准化角色描述系统
  - 详细的外观特征记录（年龄、性别、种族、肤色、发型、服装等）
  - 跨页面角色外观一致性维护

- **高质量插图**：
  - 使用Gemini Imagen 4.0生成1024x1024高分辨率图像
  - 专为儿童绘本优化的提示词工程
  - 无文字、安全内容保证

### 3. 语音合成功能
- **Azure语音服务集成**：使用中文神经语音（小艺Neural）
- **全书朗读**：为每页故事和封面生成语音文件
- **高质量音频**：16Khz 32KBit MP3格式输出
- **并行生成**：音频和图像同时生成，提高效率

### 4. 完整的绘本制作流程
- **两步生成**：
  1. 第一步：生成故事结构和角色场景详细描述
  2. 第二步：生成具体的10页故事内容
- **并行处理**：同时生成所有页面的图像提示词、图片和音频
- **实时进度**：显示生成进度和状态反馈

### 5. PDF导出功能
- **专业排版**：使用ReportLab生成高质量PDF
- **中文字体支持**：自动检测和注册系统中文字体
- **完整布局**：
  - 封面：图片居中，标题在底部
  - 内容页：上图下文布局
  - 页码：自动添加页码信息
- **图文结合**：保持原有的视觉效果和文本内容

### 6. 完整的日志记录系统
- **会话管理**：每次生成创建独立的日志会话
- **详细记录**：
  - API请求和响应日志
  - 生成的故事内容
  - 图像提示词和图片文件
  - 会话信息和统计数据
- **数据恢复**：支持从日志中恢复绘本数据

### 7. 错误处理和重试机制
- **智能重试**：API调用失败自动重试，支持退避和抖动
- **配额管理**：检测API配额限制，智能停止后续请求
- **失败恢复**：支持重新生成失败的图片
- **详细错误记录**：完整的错误日志和调试信息

## 🛠️ 技术架构

### 后端技术栈
- **Flask**：Web应用框架
- **Gemini API**：主要的AI文本和图像生成服务
- **OpenAI API**：备用的文本生成服务
- **Azure Cognitive Services**：语音合成服务
- **ReportLab**：PDF生成库
- **Pillow**：图像处理库
- **多线程并发**：使用ThreadPoolExecutor优化生成速度

### 前端技术栈
- **HTML5/CSS3**：现代响应式界面
- **JavaScript**：交互逻辑和动画效果
- **Fetch API**：异步通信

### API接口设计
- **RESTful API**：标准的REST接口设计
- **JSON通信**：统一的JSON请求响应格式
- **错误处理**：完善的错误响应机制

## 📦 安装说明

### 1. 克隆项目
```bash
git clone <repository-url>
cd StoryCanvas
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 配置API密钥
在 `config.py` 文件中设置您的API密钥。（详见环境变量配置说明.md）


或者设置环境变量：
```bash
export OPENAI_API_KEY="your-openai-api-key-here"
export GEMINI_API_KEY="your-gemini-api-key-here"
export AZURE_SPEECH_KEY="your-azure-speech-key-here"
```

### 4. 启动应用
```bash
python run.py
```

访问 http://localhost:5000 开始使用！

## 🚀 使用指南

### 创建绘本
1. **填写故事信息**:
   - 故事主题（如：勇气与友谊）
   - 主要角色（如：小松）
   - 故事背景（如：神奇的云端世界）
   - 角色描述（详细的外观特征）
   - 场景描述（环境和氛围）

2. **选择画风**：从10种不同的艺术风格中选择

3. **点击生成**：系统将自动创作10页完整绘本

4. **浏览绘本**：使用导航按钮翻页或点击自动播放

5. **导出PDF**：点击导出按钮下载完整绘本

### 示例输入
```
故事主题: 勇气与友谊
主要角色: 小松
故事背景: 神奇的云端世界
角色描述: 一个6岁的小男孩，有着黑色的短发，穿着蓝色的上衣和棕色的短裤，眼睛圆圆的很可爱
场景描述: 高高的云端之上，有着柔软洁白的云朵，给人宁静祥和的感觉
```

## 🎨 系统架构

```
StoryCanvas/
├── app.py              # Flask主应用
├── config.py           # 配置文件
├── run.py             # 启动脚本
├── requirements.txt   # Python依赖
├── templates/         # HTML模板
│   └── index.html
├── static/           # 静态资源
│   ├── css/
│   │   └── style.css
│   ├── js/
│   │   └── app.js
│   └── images/
├── exports/          # PDF导出目录
├── uploads/          # 文件上传目录
├── logs/            # 日志文件目录
└── README.md
```

## 🎨 用户体验特色

### 1. 聊天式交互
- **自然语言输入**：用户可以用自然语言描述想要的故事
- **智能理解**：AI自动理解用户意图，提取关键信息
- **一键生成**：简单的操作流程，一键生成完整绘本

### 2. 实时反馈
- **进度显示**：实时显示生成进度和状态
- **详细日志**：控制台输出详细的生成过程信息
- **成功统计**：显示生成成功的图片和音频数量

### 3. 灵活的配置选项
- **多种画风**：10种不同的艺术风格可选
- **自定义内容**：支持用户自定义故事内容和角色描述
- **可选功能**：语音合成功能可选开启

### 4. 完整的数据管理
- **会话保存**：每次生成都有完整的会话记录
- **数据恢复**：支持从历史会话中恢复绘本
- **导出功能**：支持PDF格式导出和下载

## 📊 性能优化

### 1. 并发处理
- **并行生成**：图像和音频同时生成
- **多线程优化**：使用线程池提高处理效率
- **资源管理**：智能的并发数控制

### 2. 错误恢复
- **自动重试**：网络错误和临时故障自动重试
- **配额保护**：检测配额限制，避免无效请求
- **部分失败处理**：支持部分成功的结果处理

### 3. 存储优化
- **文件管理**：有序的文件存储结构
- **缓存机制**：避免重复生成相同内容
- **清理机制**：自动清理临时文件

## 📋 API接口

### POST /api/generate_story
生成完整绘本

**请求参数:**
```json
{
  "theme": "故事主题",
  "main_character": "主要角色",
  "setting": "故事背景",
  "character_desc": "角色描述",
  "scene_desc": "场景描述",
  "style": "画风选择"
}
```

**响应格式:**
```json
{
  "success": true,
  "storybook": {
    "id": "绘本ID",
    "theme": "故事主题",
    "pages": [...],
    "cover": {...}
  }
}
```

### POST /api/export_pdf
导出PDF文件

### GET /api/get_current_storybook
获取当前绘本数据

## 🔍 技术细节

### 故事生成算法
1. **主题分析**: 解析用户输入的主题关键词
2. **结构规划**: 设计10页的故事结构框架
3. **内容生成**: 逐页生成具体的故事内容
4. **连贯性优化**: 确保前后页面的逻辑连接

### 插图一致性算法
1. **角色特征提取**: 从描述中提取关键视觉特征
2. **模板化描述**: 标准化角色和场景描述格式
3. **提示词增强**: 在每个提示词中重复关键特征
4. **风格统一**: 使用一致的艺术风格描述

## 🔧 配置和部署

### 环境配置
- **API密钥管理**：支持环境变量和配置文件
- **服务检测**：自动检测可用的AI服务
- **灵活配置**：支持多种部署环境

### 依赖管理
- **Python 3.7+**：现代Python版本支持
- **完整依赖列表**：requirements.txt包含所有必需依赖
- **版本兼容性**：经过测试的依赖版本组合

## 🐛 故障排除

### 常见问题

**1. API密钥错误**
```
解决方案: 检查config.py中的API密钥设置
```

**2. 图像生成失败**
```
解决方案: 检查网络连接和API配额限制
```

**3. PDF导出错误**
```
解决方案: 确保exports目录有写入权限
```

**4. 依赖安装失败**
```
解决方案: 使用虚拟环境并更新pip版本
```

**5. 语音合成失败**
```
解决方案: 检查Azure语音服务配置和网络连接
```

## 📈 扩展能力

### 已实现的扩展功能
- **多AI引擎支持**：Gemini + OpenAI双引擎
- **多种输出格式**：图像 + 音频 + PDF
- **完整的日志系统**：便于调试和数据分析
- **多种画风选择**：10种不同的艺术风格

### 设计的扩展接口
- **画风系统**：易于添加新的艺术风格
- **语音引擎**：可扩展其他语音合成服务
- **存储后端**：支持不同的存储方案

## 🚧 开发计划

- [ ] 支持更多绘画风格选择
- [ ] 添加故事模板库
- [ ] 实现用户账户系统
- [ ] 支持多语言生成
- [ ] 移动端适配优化
- [ ] 支持更多音频格式
- [ ] 添加绘本分享功能

## 🤝 贡献指南

欢迎提交Issue和Pull Request来改进项目！

**StoryCanvas** 是一个功能完整、技术先进的AI绘本生成系统，为用户提供了从创意到成品的完整解决方案。通过智能的AI技术和优秀的用户体验设计，让每个人都能轻松创作出专业水准的儿童绘本。✨